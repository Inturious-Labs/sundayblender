{{ define "main" }}

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            {{ $post_class := "post-head-wrapper-text-only"}}
            {{ $featured_image := .Params.featured_image }}
            {{ if $featured_image }}
                {{ $post_class = "post-head-wrapper"}}
            {{ end }}

            <div class="{{$post_class}}"
                {{ if $featured_image }}
                    {{ $image := .Resources.GetMatch (.Params.featured_image) }}
                    {{ if $image }}
                    style="background-image: url('{{$image.RelPermalink }}')"
                    {{ else }}
                    style="background-image: url('{{ $featured_image | absURL}}')"
                    {{ end }}
                {{ end }}
            >
                <div class="post-title">
                    {{ .Title }}
                    {{ if .Params.description }}
                    <div class="post-subtitle">
                        {{ .Params.description }}
                    </div>
                    {{ end }}
                    <div class="post-meta">
                        {{ if .Params.date}}
                        <time itemprop="datePublished">
                            {{ i18n "format_date" .PublishDate }}
                        </time>
                        {{ end }}

                        {{ if .Params.categories }}
                            <i class="material-icons" style="">folder</i>
                                <a href="{{ "/categories/" | relLangURL }}{{ .Params.categories | urlize }}/">{{ .Params.categories }}</a>
                                &nbsp;
                        {{ end }}

                        {{ if gt .Params.tags 0 }}
                            <i class="material-icons" style="">label</i>
                            {{ range .Params.tags }}
                                <a href="{{ "/tags/" | relLangURL }}{{ . | urlize }}/">{{ . }}</a>
                                &nbsp;
                            {{ end }}
                        {{ end }}
                        {{ if and .Site.Params.enableReadingTime (not .Params.disableReadingTime) }}
                            <i class="material-icons" style="">schedule</i>
                            {{ $readTime := mul (div (countwords .Content) 220.0) 60 }}

                            {{ $minutes := math.Floor (div $readTime 60) }}
                            {{ $seconds := mod $readTime 60 }}

                            {{ if gt $minutes 0}}
                            {{ $minutes }} {{ cond (eq $minutes 1) "minute" "min" }}
                            {{ end }}
                            {{ $seconds }} {{ cond (eq $seconds 1) "second" "s" }}.
                        {{ end }}
                    </div>
                </div>
            </div>
            
            <!-- Newsletter Sign-up Form - Top placement for A/B testing -->
            <div id="newsletter-top-placement" style="display: none;">
                <!-- Newsletter form will be moved here by JavaScript for Variant B -->
            </div>

            <div class="post-body-wrapper">
                {{ if .Params.enableVue }}
                <div class="post-body">
                {{ else }}
                <div class="post-body" v-pre>
                {{ end }}
                    {{.Content}}
                    {{ if not .Lastmod.IsZero }}
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">{{ i18n "last_mod_on" .Page.Lastmod }}</p>
                    {{ end }}
                </div>
            </div>

            <!-- PDF Download Section -->
            {{- if and (.Params.date) (not .Params.hidePDF) }}
                {{ $cleanTitle := .Title | replaceRE " " "-" | replaceRE "[\"']" "" | replaceRE "," "-" | replaceRE "[<>:\"/\\\\|?*]" "" | replaceRE "-+" "-" }}
                {{ $pdfFileName := printf "The-Sunday-Blender-%s-%s.pdf" (.Date.Format "2006-01-02") $cleanTitle }}
                {{ $pdfStaticPath := printf "static/pdf/%s" $pdfFileName }}
                {{- if (fileExists $pdfStaticPath) }}
                {{ $pdfUrl := printf "/pdf/%s" $pdfFileName }}
                {{ $fileInfo := os.Stat $pdfStaticPath }}
                {{ $fileSize := $fileInfo.Size }}
                {{ $fileSizeMB := div $fileSize 1048576.0 }}
                {{ $fileSizeFormatted := printf "%.1f MB" $fileSizeMB }}
                <div class="pdf-download-section" style="margin: 2rem 0; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem;">ðŸ“„</span>
                        <div>
                            <p style="margin: 0; font-size: 0.9rem; color: #666;">Perfect for offline reading and printing â€¢ {{ $fileSizeFormatted }}</p>
                            <a href="{{ $pdfUrl }}"
                               style="display: inline-block; margin-top: 0.75rem; background: #0066cc; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 5px; font-weight: 600; font-size: 0.9rem; transition: background-color 0.2s;"
                               onmouseover="this.style.backgroundColor='#0052a3'"
                               onmouseout="this.style.backgroundColor='#0066cc'">
                                Download PDF version
                            </a>
                        </div>
                    </div>
                </div>
                {{- end }}
            {{- end }}
            
            <!-- Rapport Comments Widget -->
            {{ if .Params.enable_rapport }}
            <div style="margin: 3rem 0; padding: 2rem; background: #f8f9fa; border-radius: 8px;">
                <h3 style="margin-bottom: 1.5rem;">Comments & Discussion</h3>
                <script src="https://kdcro-gqaaa-aaaai-q34gq-cai.icp0.io/ic-agent-bundle.js"></script>
                <script src="https://kdcro-gqaaa-aaaai-q34gq-cai.icp0.io/ic-agent.js"></script>
                <script src="https://kdcro-gqaaa-aaaai-q34gq-cai.icp0.io/widget.js"></script>
                <div id="rapport"></div>
                <script>
                  ICComments.init({
                    canisterId: 'kedx2-liaaa-aaaai-q34ga-cai',
                    pageUrl: '{{ .Permalink }}'
                  });
                </script>
            </div>
            {{ end }}

            <!-- Newsletter Sign-up Form - Bottom placement (default) -->
            <div id="newsletter-bottom-placement">
                {{ if not .Params.disableSubscribe }}
                    {{- partial "newsletter-signup.html" . -}}
                {{ end }}
            </div>
            
            <!-- Post pagination - Only show if not disabled -->
            {{ if not .Params.disablePagination }}
            <nav class="post-pagination">

                {{if .Next}}
                <a class="newer-posts" href="{{.Next.RelPermalink}}">
			{{ i18n "next_link" }}<br>{{.Next.Title}}
                </a>
                {{else}}
                <a class="newer-posts">
			{{ i18n "next_link" }}<br>{{ i18n "no_newer_posts" }}
                </a>
                {{end}}
                
                {{if .Prev}}
                <a class="older-posts" href="{{.Prev.RelPermalink}}">
			{{ i18n "prev_link" }}<br>{{.Prev.Title}}
                </a>
                {{else}}
                <a class="older-posts">
			{{ i18n "prev_link" }}<br>{{ i18n "no_older_posts" }}
                </a>
                {{end}}
            </nav>
            {{ end }}
            <div class="post-comment-wrapper">
                {{ if eq .Params.comment false }}
                <p style="opacity: 0.6" align="center">
                    <small>{{ i18n "comments_disabled" }}</small>
                </p>
                {{ else }}
                {{- partial "comment.html" . -}}
                {{ end }}
            </div>
        </div>
    </div>

{{ end }}
